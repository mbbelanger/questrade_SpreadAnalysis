# Trade Performance Analyzer

## Overview

The Trade Performance Analyzer (`trade_analyzer.py`) is a powerful backtesting tool that analyzes past trade recommendations and calculates their current P&L based on real-time market prices.

## What It Does

1. **Lists archived trade recommendations** from previous days
2. **Fetches current market prices** for all option legs
3. **Calculates P&L** for each trade (entry vs current prices)
4. **Detects expired options** and marks them as total loss
5. **Generates comprehensive reports** with win rates, best/worst trades, and strategy performance
6. **Saves results to CSV** for further analysis

## Usage

### Basic Usage

```bash
python trade_analyzer.py
```

### Interactive Flow

1. **Lists available archived files**:
   ```
   Found 3 archived recommendation file(s):

     1. trade_recommendations_2025-11-09.csv (Date: 2025-11-09)
     2. trade_recommendations_2025-11-10.csv (Date: 2025-11-10)
     3. trade_recommendations_2025-11-08.csv (Date: 2025-11-08)
   ```

2. **Select a file to analyze**:
   ```
   Enter the number of the file to analyze (or 'q' to quit): 2
   ```

3. **View detailed analysis**:
   ```
   ============================================================
   Analyzing: NVDA - bull_call_spread_near
   Entry Date: 2025-11-10 12:02:03
   Expiry: 2025-11-14
   Trade: Buy 195.0C @4.25 / Sell 200.0C @2.09

   Parsed 2 leg(s)
     Leg 1: Buy 195.0C - Entry: $4.25, Current: $5.80 (Bid: $5.75, Ask: $5.85)
     Leg 2: Sell 200.0C - Entry: $2.09, Current: $3.20 (Bid: $3.15, Ask: $3.25)

   üí∞ P&L Analysis:
      Entry Cost: -$216.00
      Exit Value: $260.00
      Net P&L: $44.00 (+20.37%)
   ```

4. **Get summary report**:
   ```
   ============================================================
   SUMMARY REPORT
   ============================================================

   Total Trades: 6
   Winners: 4 (66.7%)
   Losers: 2 (33.3%)
   Breakeven: 0

   Win Rate: 66.67%
   Total P&L: $523.00
   Average P&L per trade: $87.17
   Average Win: $185.75
   Average Loss: -$80.50

   üèÜ Best Trade: MSFT straddle - $245.00 (+31.52%)
   üíî Worst Trade: TSLA long_call - -$189.00 (-17.26%)

   üìä By Strategy:
     bull_call_spread_near: 2 trades, $124.00 P&L, 100.0% win rate
     straddle: 1 trades, $245.00 P&L, 100.0% win rate
     long_call: 2 trades, $54.00 P&L, 50.0% win rate
     bear_put_spread_mid: 1 trades, $100.00 P&L, 100.0% win rate
   ```

5. **Results saved to timestamped file**:
   ```
   ‚úÖ Results saved to: trade_analysis_2025-11-11_143522.csv
   ```

## Output Files

### CSV Output Format

The analyzer generates `trade_analysis_YYYY-MM-DD_HHMMSS.csv` with columns:

| Column | Description |
|--------|-------------|
| `symbol` | Stock ticker |
| `strategy` | Strategy type (e.g., bull_call_spread_near) |
| `expiry` | Option expiry date |
| `entry_date` | When the trade was recommended |
| `status` | ACTIVE or EXPIRED |
| `entry_cost` | Initial cost/credit |
| `exit_value` | Current market value |
| `pnl` | Profit/Loss in dollars |
| `pnl_pct` | Profit/Loss percentage |

### Example Output

```csv
symbol,strategy,expiry,entry_date,status,entry_cost,exit_value,pnl,pnl_pct
NVDA,bull_call_spread_near,2025-11-14,2025-11-10 12:02:03,ACTIVE,-216.00,260.00,44.00,20.37
TSLA,long_call,2025-11-14,2025-11-10 12:02:05,ACTIVE,-1095.00,906.00,-189.00,-17.26
MSFT,straddle,2025-11-14,2025-11-10 12:02:12,ACTIVE,-1035.00,1280.00,245.00,23.67
QQQ,bull_call_spread_near,2025-11-10,2025-11-10 12:02:02,EXPIRED,-108.00,0.00,-108.00,-100.00
```

## Key Features

### 1. Expired Options Detection

Automatically detects if options have expired and marks them as total loss:

```
‚ö†Ô∏è  EXPIRED 1 days ago - Options are worthless
```

### 2. Multi-Leg Support

Handles all strategy types:
- Bull call spreads (near/mid/long)
- Bear put spreads (near/mid/long)
- Long calls
- Long puts
- Straddles
- Iron condors

### 3. Real-Time Pricing

Fetches current bid/ask/last prices for each option leg and calculates mid-point for exit valuation.

### 4. Retry Logic

Built-in exponential backoff for API calls to handle rate limits and timeouts (30s ‚Üí 60s ‚Üí 90s).

### 5. P&L Calculation

Properly accounts for:
- **Buy legs**: Cost at entry, value at current price
- **Sell legs**: Credit at entry, cost at current price
- **Net P&L**: Total profit/loss including all legs

### 6. Strategy Performance Breakdown

Shows win rate and total P&L for each strategy type, helping you identify which strategies work best.

## Requirements

- Active Questrade API connection
- Valid refresh token in `.env` file
- Archived trade recommendation files (generated by `trade_generator.py`)

## Example Use Cases

### 1. Daily Performance Review

Run at end of trading day to see how today's recommendations performed:

```bash
python trade_analyzer.py
# Select today's archived file
```

### 2. Weekly Strategy Review

Analyze last week's recommendations to identify winning strategies:

```bash
python trade_analyzer.py
# Select Monday's file
```

### 3. Post-Expiry Analysis

Check how expired trades performed (for learning/improvement):

```bash
python trade_analyzer.py
# Select file from 1 week ago
```

## Interpreting Results

### Positive P&L
- Trade is profitable at current prices
- Consider closing to lock in profits or let it run

### Negative P&L
- Trade is losing at current prices
- Evaluate if thesis still valid or cut losses

### Expired Trades
- -100% P&L indicates total loss
- Use to learn from past mistakes

## Tips

1. **Run regularly**: Check performance daily to track your strategy effectiveness
2. **Compare timeframes**: For spreads, compare near/mid/long term performance
3. **Strategy selection**: Use win rate data to focus on best-performing strategies
4. **Risk management**: Identify losing patterns to improve risk controls

## Troubleshooting

### "No archived files found"
- Run `trade_generator.py` first to create recommendations
- Recommendations are automatically archived when you run the generator

### "Could not find symbol ID"
- Check ticker symbol is valid
- API might be experiencing issues, retry later

### "Could not find option chain"
- Expiry date might not exist
- Symbol might not have options listed

### Rate limit errors
- Wait a few seconds and retry
- Built-in backoff will handle this automatically

## Integration

Works seamlessly with:
- `strategy_selector.py` - Identifies strategy opportunities
- `trade_generator.py` - Creates detailed trade recommendations
- `trade_executor.py` - Executes trades with Questrade

## Future Enhancements

Potential additions:
- Greeks tracking (delta, theta, gamma)
- Intraday P&L snapshots
- Email/SMS alerts for P&L thresholds
- Interactive charts with plotly
- Portfolio-level analysis across multiple dates
